#!/bin/bash

aws='aws'
verbose=false

while [ $# -gt 0 ]; do
    case "$1" in
        -local)
            shift; aws='aws --profile local --endpoint-url http://127.0.0.1:8000'
            ;;
        -verbose)
            shift; verbose=true
            ;;
        -debug)
            shift; set -x
            ;;
        -prefix)
            shift; table_prefix="${1}-"; shift
            ;;
        *)
            break
    esac
done

function jjwrap()
{
    local line
    if which jj >/dev/null 2>&1; then
        $verbose && jj || jj "$@"
    else
        while read line; do echo "$line"; done
    fi
}

function key()
{
    echo "{\"$1\":{\"AttributeValueList\":[{\"S\":\"$2\"}],\"ComparisonOperator\":\"EQ\"}}"
}

function table()
{
    echo -- "--table-name ${table_prefix}${1}"
}

declare -a usages

usages=( "${usages[@]}" 'ec2_by_name <name_with_globs>' )
function ec2_by_name()
{
    exec $aws ec2 describe-instances --filters "Name=tag-value,Values=$1"
}

usages=( "${usages[@]}" 'forget_source <source_id> <app_id>' )
function forget_source()
{
    exec $aws dynamodb delete-item `table sources` --key '{"source_id":{"S":"'$1'"},"app_id":{"S":"'$2'"}}'
}

usages=( "${usages[@]}" 'get_interstitial <app_id>' )
function get_interstitial()
{
    exec $aws dynamodb query `table interstitials` --key-conditions `key app_id $1` \
        | jjwrap -e Items.0.interstitial.S
}

usages=( "${usages[@]}" 'get_interactions <source_id>' )
function get_interactions()
{
    exec $aws dynamodb query `table source_interactions` --key-conditions `key source_id $1` \
        | jjwrap -e Items
}

usages=( "${usages[@]}" 'get_installs <app_id>' )
function get_installs()
{
    exec $aws dynamodb query `table installs` --key-conditions `key app_id $1` \
        | jjwrap -e Items
}

usages=( "${usages[@]}" 'get_clicks <app_id>' )
function get_clicks()
{
    exec $aws dynamodb query `table clicks` --key-conditions `key app_id $1` \
        | jjwrap -e Items
}

usages=( "${usages[@]}" 'get_impressions <app_id>' )
function get_impressions()
{
    exec $aws dynamodb query `table impressions` --key-conditions `key app_id $1` \
        | jjwrap -e Items
}

usages=( "${usages[@]}" 'get_source <app_id>' )
function get_source()
{
    exec $aws dynamodb scan `table sources` --scan-filter `key app_id $1` \
        | jjwrap -e Items
}

usages=( "${usages[@]}" 'list_tables' )
function list_tables()
{
    if [ -z "$table_prefix" ]; then
        exec $aws dynamodb list-tables | jjwrap -e TableNames
    else
        exec $aws dynamodb list-tables | jjwrap -e TableNames | grep -F "\"${table_prefix}"
    fi
}

usages=( "${usages[@]}" 'scan <table>' )
function scan()
{
    exec $aws dynamodb scan `table $1` | jjwrap -e Items
}

if [ $# -lt 1 ]; then
    bn="$(basename "$0" .sh)"
    indent="$(printf "       %${#bn}s " ' ')"
    echo -e "\nusage: ${bn} [-local] [-verbose] [-prefix <env>] ...\n" 1>&2
    for usage in "${usages[@]}"; do
        echo "${indent}${usage}" 1>&2
    done
    echo 1>&2
    exit 1
fi

function check_args()
{
    local cmd=$1; shift
    local need=-2
    local usage=''
    local arg

    for usage in "${usages[@]}"; do
        if [[ $usage = $cmd* ]]; then
            need=-1; for arg in $usage; do ((need++)); done
            [ $need -eq -1 ] && return # no arguments required
            break
        fi
    done

    if [ $need -lt -1 ]; then
        echo "unknown command: $cmd $@" 1>&2
        exit 2
    fi

    if [ $# -ne $need ]; then
        cat <<EOF 1>&2

usage: $(basename "$0" .sh) $usage

EOF
        exit 3
    fi
}

check_args "$@"
"$@"
