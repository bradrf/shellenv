#!/usr/bin/env python

import sys
import signal

from argparse import ArgumentParser, ArgumentDefaultsHelpFormatter
from s3tail import S3Tail

parser = ArgumentParser(formatter_class=ArgumentDefaultsHelpFormatter)

parser.add_argument('-r', '--region', help='AWS region to use when connecting')
parser.add_argument('-b', '--bookmark', help='Bookmark of last key:line shown')
parser.add_argument('s3_uri', help='s3://BUCKET[/PREFIX]')

args = parser.parse_args()
bucket, prefix = args.s3_uri[5:].split('/', 1)

tail = None

def signal_handler(signal, frame):
    print 'Stopped at', tail.get_bookmark()
    sys.exit(0)
signal.signal(signal.SIGINT, signal_handler)

def progress(key):
    print 'Starting', key
    return True

def dump(num, line):
    print line

tail = S3Tail(bucket, prefix, dump,
              key_handler=progress, bookmark=args.bookmark, region=args.region)
tail.watch()

print 'No more logs'
sys.exit(0)
