#!/usr/bin/env python

import os
import re
from hashlib import sha256
import argparse
import multiprocessing
import boto.ec2
import boto.route53

def get_region_instances(region):
    try:
        instances = []
        for instance in boto.ec2.connect_to_region(region).get_only_instances():
            if instance.state != 'running': continue
            instance.pub = instance.public_dns_name
            instance.priv = instance.private_ip_address
            try:
                instance.name = instance.tags['Name'].lower()
                del(instance.tags['Name'])
            except:
                instance.name = instance.pub if instance.pub is not None else instance.priv
            instances.append(instance)
        return instances
    except boto.exception.EC2ResponseError:
        # print 'Unable to get instances in region:', region
        return []

def get_instances():
    regions = [r.name for r in boto.ec2.regions()];
    pool = multiprocessing.Pool(len(regions))
    instances = pool.map(get_region_instances, regions)
    return [val for subl in instances for val in subl] # flatten

def get_dns_records(zone):
    aws_zone = boto.route53.connection.Route53Connection().get_zone(zone)
    return boto.route53.connection.Route53Connection().get_all_rrsets(aws_zone.id)

def get_dns_name(value, records):
    names = []
    for record in records:
        if record.type not in ['A','CNAME']:
            continue
        if value in record.resource_records or value == record.alias_dns_name:
            names.append(record.name.rstrip('.'))
    return names

################################################################################

# TODO:
# * add helpers to read ssh config and provide meta data on arguments to match (i.e. to lookup entries)

parser = argparse.ArgumentParser()
parser.add_argument('-z', '--zone', help='DNS Zone Name')
args = parser.parse_args()

# get a safe name for these hosts according to the access id in use
# (so multiple sets can be maintained in the same file for different access keys)
access_id = boto.connect_ec2().aws_access_key_id
name = sha256(access_id).hexdigest()[0:8]

profile = os.getenv('AWS_PROFILE','default').upper()
begin_marker = '### %s AWS HOSTS BEGIN (%s) ###' % (profile, name)
zone_marker = '### AWS ZONE: '
end_marker = '### %s AWS HOSTS END (%s) ###' % (profile, name)

ssh_config_fn = os.path.join(os.path.expanduser('~'),'.ssh','config')
confdir = os.path.dirname(ssh_config_fn)
if not os.path.exists(confdir):
    os.makedirs(confdir)

before_lines = []
after_lines = []
if os.path.exists(ssh_config_fn):
    conf = open(ssh_config_fn, 'r')
    state = 0
    for line in conf:
        if state == 0:
            if line.strip() == begin_marker:
                state = 1
            else:
                before_lines.append(line)
            continue
        elif state == 1:
            stripped = line.strip()
            if stripped == end_marker:
                state = 2
            elif args.zone == None:
                m = re.match('^'+zone_marker+'(.*)', stripped)
                if m:
                    args.zone = m.group(1)
            continue
        after_lines.append(line)
    conf.close()
    if state == 1:
        print 'Never located end marker: ' + end_marker
        exit(1)

dns_records = get_dns_records(args.zone) if args.zone else []

conf = open(ssh_config_fn, 'w')
for line in before_lines:
    conf.write(line)

count = 0
conf.write(begin_marker + '\n')
if args.zone:
    conf.write(zone_marker + args.zone + '\n')

for instance in sorted(get_instances(), key=lambda i: i.name):
    if instance.platform: continue # not linux, probably won't support ssh
    tags = ' '.join('%s=%s'%(k,v) for k,v in instance.tags.iteritems())
    conf.write('''\n# id=%s region=%s %s\nHost        %s.private\nHostname    %s\n''' %
               (instance.id, instance.placement, tags, instance.name, instance.priv))
    if instance.pub:
        conf.write('''Host        %s\nHostname    %s\n''' % (instance.name, instance.pub))
        for dns_name in get_dns_name(instance.pub, dns_records):
            conf.write('''Host        %s\nHostname    %s\n''' % (dns_name, instance.pub))
    count += 1

conf.write('\n' + end_marker + '\n')
for line in after_lines:
    conf.write(line)

conf.close()
print 'Updated %s host entries in %s' % (count, ssh_config_fn)
